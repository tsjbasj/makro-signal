<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Makro Signal</title>
  <style>
    :root {
      --bg: #0a0e1a;
      --panel: #111827;
      --border: #1e2d45;
      --accent: #00ff88;
      --red: #ff4455;
      --yellow: #ffcc00;
      --text: #c8d6e8;
      --muted: #4a6080;
      --font: 'Courier New', Courier, monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px 48px;
    }
    header {
      width: 100%;
      max-width: 780px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      padding-bottom: 14px;
      margin-bottom: 32px;
    }
    .logo { font-size: 1.1rem; letter-spacing: 0.2em; color: var(--accent); text-transform: uppercase; }
    .logo span { color: var(--muted); font-size: 0.75rem; }
    #timestamp { font-size: 0.72rem; color: var(--muted); text-align: right; }
    main { width: 100%; max-width: 780px; }

    /* Signal box */
    #signal-box {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 36px 28px 28px;
      text-align: center;
      margin-bottom: 20px;
      position: relative;
    }
    #signal-box::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--accent);
      transition: background 0.5s;
    }
    #signal-box.sig-nej::before { background: var(--red); }
    #signal-box.sig-vent::before { background: var(--yellow); }

    .signal-label { font-size: 0.7rem; letter-spacing: 0.25em; color: var(--muted); text-transform: uppercase; margin-bottom: 12px; }
    #signal-text {
      font-size: 5.5rem; font-weight: 900; letter-spacing: 0.05em;
      line-height: 1; color: var(--accent);
      text-shadow: 0 0 40px var(--accent);
      transition: color 0.4s, text-shadow 0.4s;
    }
    #signal-text.sig-nej  { color: var(--red);    text-shadow: 0 0 40px var(--red); }
    #signal-text.sig-vent { color: var(--yellow); text-shadow: 0 0 40px var(--yellow); }
    #niveau-text { margin-top: 10px; font-size: 0.95rem; color: var(--muted); letter-spacing: 0.12em; }
    #niveau-text.on { color: var(--accent); }

    #bullets { list-style: none; margin: 24px 0 0; text-align: left; }
    #bullets li { padding: 8px 0 8px 20px; position: relative; font-size: 0.88rem; border-bottom: 1px solid var(--border); }
    #bullets li:last-child { border-bottom: none; }
    #bullets li::before { content: '▸'; position: absolute; left: 0; color: var(--accent); }
    #bullets li.warn::before { color: var(--red); }
    #bullets li.mid::before  { color: var(--yellow); }

    /* Table */
    .section-title { font-size: 0.65rem; letter-spacing: 0.3em; color: var(--muted); text-transform: uppercase; margin: 28px 0 10px; }
    #data-table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
    #data-table th { text-align: left; color: var(--muted); font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; padding: 8px 10px; border-bottom: 1px solid var(--border); }
    #data-table td { padding: 10px; border-bottom: 1px solid #0f1929; vertical-align: middle; }
    #data-table tr:last-child td { border-bottom: none; }
    .td-val { font-size: 1rem; font-weight: bold; text-align: right; }
    .td-sig { text-align: right; font-size: 0.75rem; letter-spacing: 0.1em; }
    .td-bar { width: 120px; }
    .bar-track { background: var(--border); border-radius: 2px; height: 6px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 2px; background: var(--accent); transition: width 1s ease; }
    .bar-fill.warn { background: var(--red); }
    .bar-fill.mid  { background: var(--yellow); }
    .c-ok   { color: var(--accent); }
    .c-warn { color: var(--red); }
    .c-mid  { color: var(--yellow); }
    .c-muted{ color: var(--muted); }

    /* ISM manual input */
    .ism-edit-btn {
      background: none; border: 1px dashed var(--muted); color: var(--muted);
      font-family: var(--font); font-size: 0.7rem; padding: 2px 8px;
      cursor: pointer; border-radius: 2px; margin-left: 8px;
      letter-spacing: 0.1em;
      transition: border-color 0.2s, color 0.2s;
    }
    .ism-edit-btn:hover { border-color: var(--accent); color: var(--accent); }
    #ism-input-row { margin-top: 10px; padding: 12px 10px; background: #0d1520; border: 1px solid var(--border); border-radius: 3px; display: none; }
    #ism-input-row label { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.1em; display: block; margin-bottom: 6px; }
    #ism-input-row input {
      background: var(--bg); border: 1px solid var(--border); color: var(--text);
      font-family: var(--font); font-size: 0.9rem; padding: 6px 10px;
      width: 100px; border-radius: 2px;
    }
    #ism-input-row button {
      background: var(--accent); border: none; color: var(--bg);
      font-family: var(--font); font-size: 0.75rem; padding: 7px 14px;
      cursor: pointer; border-radius: 2px; margin-left: 8px;
      letter-spacing: 0.1em;
    }
    #ism-date-note { font-size: 0.65rem; color: var(--muted); margin-top: 6px; }

    /* Footer */
    .footer-row { display: flex; justify-content: space-between; align-items: center; margin-top: 28px; flex-wrap: wrap; gap: 12px; }
    #cache-note { font-size: 0.68rem; color: var(--muted); }
    #refresh-btn {
      background: transparent; border: 1px solid var(--accent); color: var(--accent);
      font-family: var(--font); font-size: 0.78rem; letter-spacing: 0.15em;
      padding: 8px 20px; cursor: pointer; text-transform: uppercase;
      border-radius: 2px; transition: background 0.2s, color 0.2s;
    }
    #refresh-btn:hover { background: var(--accent); color: var(--bg); }
    #refresh-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Loader */
    #loader { text-align: center; padding: 60px 0; font-size: 0.85rem; color: var(--muted); letter-spacing: 0.2em; }
    #loader .dot { animation: blink 1.2s infinite; }
    #loader .dot:nth-child(2) { animation-delay: 0.4s; }
    #loader .dot:nth-child(3) { animation-delay: 0.8s; }
    @keyframes blink { 0%,80%,100%{opacity:0.2} 40%{opacity:1} }
    .hidden { display: none !important; }
    @media (max-width: 540px) { #signal-text { font-size: 4rem; } .td-bar { display: none; } }
  </style>
</head>
<body>

<header>
  <div><div class="logo">Makro Signal <span>// v1.1</span></div></div>
  <div id="timestamp">—</div>
</header>

<main>
  <div id="loader">HENTER DATA<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></div>

  <div id="content" class="hidden">
    <div id="signal-box">
      <div class="signal-label">Køb ekstra ind i markedet nu?</div>
      <div id="signal-text">—</div>
      <div id="niveau-text"></div>
      <ul id="bullets"></ul>
    </div>

    <div class="section-title">Dataoversigt</div>
    <table id="data-table">
      <thead>
        <tr>
          <th>Indikator</th>
          <th style="text-align:right">Værdi</th>
          <th style="text-align:right">Signal</th>
          <th class="td-bar">Niveau</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>

    <!-- ISM manual input panel -->
    <div id="ism-input-row">
      <label>OPDATER ISM MANUFACTURING PMI (fra ism.org / financial news)</label>
      <div style="display:flex;align-items:center;gap:4px">
        <input id="ism-val-input" type="number" step="0.1" min="30" max="70" placeholder="f.eks. 49.3" />
        <button id="ism-save-btn">GEM</button>
      </div>
      <div id="ism-date-note"></div>
    </div>

    <div class="footer-row">
      <div id="cache-note"></div>
      <button id="refresh-btn">⟳ Opdater</button>
    </div>
  </div>
</main>

<script>
const CACHE_KEY   = 'mks_v2_data';
const ISM_KEY     = 'mks_ism_manual';
const CACHE_TTL   = 24 * 60 * 60 * 1000;
const ISM_TTL     = 35 * 24 * 60 * 60 * 1000; // 35 days

function $(id) { return document.getElementById(id); }

// ── Cache ────────────────────────────────────────────────────────────────
function saveCache(data) {
  localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), data }));
}
function loadCache() {
  try {
    const { ts, data } = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null') || {};
    if (ts && Date.now() - ts < CACHE_TTL) return { data, age: Date.now() - ts };
  } catch(_) {}
  return null;
}
function fmtAge(ms) {
  const h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000);
  return h > 0 ? `Cache: ${h}t ${m}m gammel` : `Cache: ${m}m gammel`;
}

// ── ISM manual store ──────────────────────────────────────────────────────
function saveISM(val) {
  localStorage.setItem(ISM_KEY, JSON.stringify({ val, ts: Date.now() }));
}
function loadISM() {
  try {
    const { val, ts } = JSON.parse(localStorage.getItem(ISM_KEY) || 'null') || {};
    if (val && ts && Date.now() - ts < ISM_TTL) return { val: parseFloat(val), ts };
  } catch(_) {}
  return null;
}

// ── Proxy fetch ───────────────────────────────────────────────────────────
async function proxyFetch(url) {
  const res = await fetch(`/api/fetch?url=${encodeURIComponent(url)}`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res;
}

// ── Data fetchers ─────────────────────────────────────────────────────────
async function fetchFearGreed() {
  const res  = await proxyFetch('https://production.dataviz.cnn.io/index/fearandgreed/graphdata');
  const json = await res.json();
  const score = json?.fear_and_greed?.score;
  if (score == null) throw new Error('Ingen F&G score');
  return parseFloat(score);
}

async function fetchSP500() {
  const res  = await proxyFetch('https://stooq.com/q/d/l/?s=%5Espx&i=d');
  const text = await res.text();
  const rows = text.trim().split('\n').filter(r => r && !r.startsWith('Date'));
  if (rows.length < 100) throw new Error('For lidt S&P data');
  const closes = rows.map(r => parseFloat(r.split(',')[4]));
  const latest = closes[closes.length - 1];
  const high52 = Math.max(...closes.slice(-252));
  return { latest, high52, drawdown: (latest / high52 - 1) * 100 };
}

// ── Decision engine ───────────────────────────────────────────────────────
function computeSignal({ fg, sp, ism }) {
  const spPct = sp.drawdown;
  const ismVal = ism?.val ?? null;

  const jaConditions = [
    spPct <= -12,
    fg    <= 35,
    ismVal != null && ismVal <= 48,
  ];
  const nejConditions = [
    spPct > -8,
    fg    > 45,
    ismVal == null || ismVal >= 50,
  ];

  const isJA  = jaConditions.some(Boolean);
  const isNEJ = nejConditions.every(Boolean);
  let signal  = isJA ? 'JA' : isNEJ ? 'NEJ' : 'VENT';

  let niveau = '';
  if (spPct <= -25)           niveau = 'NIVEAU: STORT';
  else if (spPct <= -18 || fg <= 25) niveau = 'NIVEAU: 25%';
  else if (isJA)              niveau = 'NIVEAU: 12,5%';

  const bullets = [];
  const spStr = spPct.toFixed(1);
  if      (spPct <= -25) bullets.push({ text: `S&P 500 er ${spStr}% fra 52-ugers high — ekstremt niveau`, cls: 'warn' });
  else if (spPct <= -18) bullets.push({ text: `S&P 500 er ${spStr}% fra 52-ugers high — stort fald`, cls: 'warn' });
  else if (spPct <= -12) bullets.push({ text: `S&P 500 er ${spStr}% fra 52-ugers high — trigger aktiv (≤−12%)`, cls: 'warn' });
  else                   bullets.push({ text: `S&P 500 er ${spStr}% fra 52-ugers high — under tærskel`, cls: '' });

  if      (fg <= 25) bullets.push({ text: `Fear & Greed: ${fg.toFixed(0)} — Ekstrem frygt`, cls: 'warn' });
  else if (fg <= 35) bullets.push({ text: `Fear & Greed: ${fg.toFixed(0)} — Frygt, trigger aktiv (≤35)`, cls: 'warn' });
  else if (fg <= 45) bullets.push({ text: `Fear & Greed: ${fg.toFixed(0)} — Neutral/lav zone`, cls: 'mid' });
  else               bullets.push({ text: `Fear & Greed: ${fg.toFixed(0)} — Neutral til grådighed`, cls: '' });

  if (ismVal == null)        bullets.push({ text: 'ISM PMI: ikke sat — klik "Rediger" for at tilføje manuelt', cls: 'mid' });
  else if (ismVal <= 48)     bullets.push({ text: `ISM PMI: ${ismVal.toFixed(1)} — Kontraktion, trigger aktiv (≤48)`, cls: 'warn' });
  else if (ismVal < 50)      bullets.push({ text: `ISM PMI: ${ismVal.toFixed(1)} — Under 50, svag vækst`, cls: 'mid' });
  else                       bullets.push({ text: `ISM PMI: ${ismVal.toFixed(1)} — Ekspansion`, cls: '' });

  return { signal, niveau, bullets };
}

// ── Render ────────────────────────────────────────────────────────────────
function render({ fg, sp, ism }, fromCache, cacheAge) {
  const { signal, niveau, bullets } = computeSignal({ fg, sp, ism });
  const sigKey = signal.toLowerCase();

  const sigEl = $('signal-text');
  sigEl.textContent = signal;
  sigEl.className   = `sig-${sigKey}`;
  $('signal-box').className = `sig-${sigKey}`;

  const niv = $('niveau-text');
  niv.textContent = niveau;
  niv.className   = niveau ? 'on' : '';

  const bul = $('bullets');
  bul.innerHTML = '';
  bullets.forEach(b => {
    const li = document.createElement('li');
    li.textContent = b.text;
    li.className   = b.cls || '';
    bul.appendChild(li);
  });

  // Table
  const ismVal = ism?.val ?? null;
  const ismAge = ism?.ts ? new Date(ism.ts).toLocaleDateString('da-DK') : null;

  const rows = [
    {
      name: 'S&P 500 drawdown (52-ugers high)',
      display: `${sp.drawdown.toFixed(1)}%`,
      barPct: Math.min(100, Math.abs(sp.drawdown) / 30 * 100),
      trigger: sp.drawdown <= -12, warn: sp.drawdown <= -18,
    },
    {
      name: 'CNN Fear & Greed Index',
      display: `${fg.toFixed(0)} / 100`,
      barPct: Math.min(100, (100 - fg) / 100 * 100),
      trigger: fg <= 35, warn: fg <= 25,
    },
    {
      name: 'ISM Manufacturing PMI',
      display: ismVal != null ? ismVal.toFixed(1) : 'N/A',
      barPct: ismVal != null ? Math.min(100, Math.max(0, (60 - ismVal) / 15 * 100)) : 0,
      trigger: ismVal != null && ismVal <= 48,
      warn:    ismVal != null && ismVal <= 45,
      manual:  true,
      note:    ismAge ? `manuelt — ${ismAge}` : 'manuelt — ikke sat',
    },
  ];

  const tbody = $('table-body');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const barCls  = r.warn ? 'warn' : r.trigger ? 'mid' : '';
    const valCls  = r.warn ? 'c-warn' : r.trigger ? 'c-mid' : '';
    const sigCls  = r.warn ? 'c-warn td-sig' : r.trigger ? 'c-mid td-sig' : 'c-ok td-sig';
    const sigTxt  = r.warn ? 'TRIGGER' : r.trigger ? 'TRIGGER' : 'OK';
    const editBtn = r.manual
      ? `<button class="ism-edit-btn" onclick="toggleISMInput()">Rediger</button>` : '';

    tbody.innerHTML += `
      <tr>
        <td>${r.name}${editBtn}</td>
        <td class="td-val ${valCls}">${r.display}</td>
        <td class="${sigCls}">${r.manual && ismVal == null ? '<span class="c-muted">N/A</span>' : sigTxt}</td>
        <td class="td-bar"><div class="bar-track"><div class="bar-fill ${barCls}" style="width:${Math.max(2, r.barPct)}%"></div></div></td>
      </tr>`;
  });

  // Timestamps
  const now = new Date();
  $('timestamp').textContent = `Opdateret: ${now.toLocaleDateString('da-DK')} ${now.toLocaleTimeString('da-DK', {hour:'2-digit',minute:'2-digit'})}`;
  $('cache-note').textContent = fromCache ? fmtAge(cacheAge) : 'Live data — cache: 24 timer';

  // Prefill ISM input
  if (ismVal != null) $('ism-val-input').value = ismVal;
  if (ismAge) $('ism-date-note').textContent = `Sidst sat: ${ismAge}`;

  $('loader').classList.add('hidden');
  $('content').classList.remove('hidden');
}

// ── ISM manual input ──────────────────────────────────────────────────────
window.toggleISMInput = function() {
  const row = $('ism-input-row');
  row.style.display = row.style.display === 'block' ? 'none' : 'block';
};

$('ism-save-btn').addEventListener('click', () => {
  const raw = parseFloat($('ism-val-input').value);
  if (isNaN(raw) || raw < 30 || raw > 70) {
    alert('Indtast en gyldig PMI-værdi (30–70)');
    return;
  }
  saveISM(raw);
  $('ism-input-row').style.display = 'none';
  const cached = loadCache();
  if (cached) render(Object.assign({}, cached.data, { ism: loadISM() }), true, Date.now() - cached.data.ts || 0);
  loadData(true);
});

// ── Main load ─────────────────────────────────────────────────────────────
async function loadData(force = false) {
  $('refresh-btn').disabled = true;
  const ism = loadISM();

  if (!force) {
    const cached = loadCache();
    if (cached) {
      render(Object.assign({}, cached.data, { ism }), true, cached.age);
      $('refresh-btn').disabled = false;
      return;
    }
  }

  $('loader').classList.remove('hidden');
  $('content').classList.add('hidden');

  try {
    const [fg, sp] = await Promise.all([fetchFearGreed(), fetchSP500()]);
    const data = { fg, sp };
    saveCache(data);
    render(Object.assign({}, data, { ism }), false, 0);
  } catch(err) {
    $('loader').classList.add('hidden');
    const cached = loadCache();
    if (cached) {
      render(Object.assign({}, cached.data, { ism }), true, cached.age);
    } else {
      $('content').classList.remove('hidden');
      alert(`Datafejl: ${err.message}`);
    }
  } finally {
    $('refresh-btn').disabled = false;
  }
}

$('refresh-btn').addEventListener('click', () => loadData(true));
loadData();
</script>
</body>
</html>
