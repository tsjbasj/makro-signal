<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Makro Signal</title>
  <style>
    :root {
      --bg: #0a0e1a;
      --panel: #111827;
      --border: #1e2d45;
      --accent: #00ff88;
      --red: #ff4455;
      --yellow: #ffcc00;
      --text: #c8d6e8;
      --muted: #4a6080;
      --font: 'Courier New', Courier, monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px 48px;
    }

    /* Header */
    header {
      width: 100%;
      max-width: 780px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      padding-bottom: 14px;
      margin-bottom: 32px;
    }

    .logo {
      font-size: 1.1rem;
      letter-spacing: 0.2em;
      color: var(--accent);
      text-transform: uppercase;
    }

    .logo span { color: var(--muted); font-size: 0.75rem; }

    #timestamp {
      font-size: 0.72rem;
      color: var(--muted);
      text-align: right;
    }

    /* Main container */
    main {
      width: 100%;
      max-width: 780px;
    }

    /* Signal box */
    #signal-box {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 36px 28px 28px;
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    #signal-box::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--accent);
      transition: background 0.5s;
    }

    #signal-box.signal-nej::before { background: var(--red); }
    #signal-box.signal-vent::before { background: var(--yellow); }

    .signal-label {
      font-size: 0.7rem;
      letter-spacing: 0.25em;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    #signal-text {
      font-size: 5.5rem;
      font-weight: 900;
      letter-spacing: 0.05em;
      color: var(--accent);
      line-height: 1;
      text-shadow: 0 0 40px currentColor;
      transition: color 0.4s;
    }

    .signal-ja   { color: var(--accent) !important; text-shadow: 0 0 40px var(--accent) !important; }
    .signal-nej  { color: var(--red) !important;    text-shadow: 0 0 40px var(--red) !important; }
    .signal-vent { color: var(--yellow) !important; text-shadow: 0 0 40px var(--yellow) !important; }

    #niveau-text {
      margin-top: 10px;
      font-size: 0.95rem;
      color: var(--muted);
      letter-spacing: 0.12em;
    }

    #niveau-text.active { color: var(--accent); }

    /* Bullets */
    #bullets {
      list-style: none;
      margin: 24px 0 0;
      text-align: left;
    }

    #bullets li {
      padding: 8px 0 8px 20px;
      position: relative;
      font-size: 0.88rem;
      color: var(--text);
      border-bottom: 1px solid var(--border);
    }

    #bullets li:last-child { border-bottom: none; }

    #bullets li::before {
      content: '▸';
      position: absolute;
      left: 0;
      color: var(--accent);
    }

    #bullets li.warn::before { color: var(--red); }
    #bullets li.caution::before { color: var(--yellow); }

    /* Data table */
    .section-title {
      font-size: 0.65rem;
      letter-spacing: 0.3em;
      color: var(--muted);
      text-transform: uppercase;
      margin: 28px 0 10px;
    }

    #data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.83rem;
    }

    #data-table th {
      text-align: left;
      color: var(--muted);
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }

    #data-table td {
      padding: 10px 10px;
      border-bottom: 1px solid #0f1929;
      vertical-align: middle;
    }

    #data-table tr:last-child td { border-bottom: none; }

    .td-name { color: var(--text); }

    .td-value {
      font-size: 1rem;
      font-weight: bold;
      text-align: right;
    }

    .td-status {
      text-align: right;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
    }

    .status-ok   { color: var(--accent); }
    .status-warn { color: var(--red); }
    .status-mid  { color: var(--yellow); }

    .td-bar { width: 120px; }

    .bar-track {
      background: var(--border);
      border-radius: 2px;
      height: 6px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 2px;
      background: var(--accent);
      transition: width 1s ease;
    }

    .bar-fill.warn { background: var(--red); }
    .bar-fill.mid  { background: var(--yellow); }

    /* Footer / refresh */
    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 28px;
      flex-wrap: wrap;
      gap: 12px;
    }

    #cache-note {
      font-size: 0.68rem;
      color: var(--muted);
    }

    #refresh-btn {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      font-family: var(--font);
      font-size: 0.78rem;
      letter-spacing: 0.15em;
      padding: 8px 20px;
      cursor: pointer;
      text-transform: uppercase;
      border-radius: 2px;
      transition: background 0.2s, color 0.2s;
    }

    #refresh-btn:hover { background: var(--accent); color: var(--bg); }
    #refresh-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Loading / error */
    #loader {
      text-align: center;
      padding: 60px 0;
      font-size: 0.85rem;
      color: var(--muted);
      letter-spacing: 0.2em;
    }

    #loader .dot { animation: blink 1.2s infinite; }
    #loader .dot:nth-child(2) { animation-delay: 0.4s; }
    #loader .dot:nth-child(3) { animation-delay: 0.8s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; }
      40% { opacity: 1; }
    }

    #error-msg {
      background: #1a0f0f;
      border: 1px solid #4a1a1a;
      color: var(--red);
      padding: 14px 18px;
      border-radius: 4px;
      font-size: 0.82rem;
      margin-top: 16px;
      display: none;
    }

    .hidden { display: none !important; }

    @media (max-width: 540px) {
      #signal-text { font-size: 4rem; }
      .td-bar { display: none; }
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="logo">Makro Signal <span>// v1.0</span></div>
  </div>
  <div id="timestamp">—</div>
</header>

<main>
  <div id="loader">
    HENTER DATA<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
  </div>

  <div id="error-msg"></div>

  <div id="content" class="hidden">

    <div id="signal-box">
      <div class="signal-label">Køb ekstra ind i markedet nu?</div>
      <div id="signal-text">—</div>
      <div id="niveau-text"></div>
      <ul id="bullets"></ul>
    </div>

    <div class="section-title">Dataoversigt</div>
    <table id="data-table">
      <thead>
        <tr>
          <th>Indikator</th>
          <th style="text-align:right">Værdi</th>
          <th style="text-align:right">Signal</th>
          <th class="td-bar">Niveau</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>

    <div class="footer-row">
      <div id="cache-note"></div>
      <button id="refresh-btn">⟳ Opdater</button>
    </div>

  </div>
</main>

<script>
const CACHE_KEY   = 'makro_signal_data';
const CACHE_TTL   = 24 * 60 * 60 * 1000; // 24 hours

// ── Helpers ──────────────────────────────────────────────────────────────
function $(id) { return document.getElementById(id); }

function saveCache(data) {
  localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), data }));
}

function loadCache() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return null;
    const { ts, data } = JSON.parse(raw);
    if (Date.now() - ts < CACHE_TTL) return { data, age: Date.now() - ts };
  } catch (_) {}
  return null;
}

function fmtAge(ms) {
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  if (h > 0) return `Cache: ${h}t ${m}m gammel`;
  return `Cache: ${m}m gammel`;
}

// ── Fetch via proxy ───────────────────────────────────────────────────────
async function proxyFetch(url) {
  const res = await fetch(`/api/fetch?url=${encodeURIComponent(url)}`);
  if (!res.ok) throw new Error(`Proxy fejl ${res.status} for ${url}`);
  return res;
}

// ── Data fetchers ─────────────────────────────────────────────────────────
async function fetchFearGreed() {
  const res  = await proxyFetch('https://production.dataviz.cnn.io/index/fearandgreed/graphdata');
  const json = await res.json();
  const score = json?.fear_and_greed?.score;
  if (score == null) throw new Error('Ingen F&G data');
  return parseFloat(score);
}

async function fetchSP500() {
  const res  = await proxyFetch('https://stooq.com/q/d/l/?s=%5Espx&i=d');
  const text = await res.text();
  const rows = text.trim().split('\n').filter(r => r && !r.startsWith('Date'));
  if (rows.length < 252) throw new Error('For lidt S&P data');

  const prices = rows.map(r => parseFloat(r.split(',')[4])); // Close
  const latest  = prices[prices.length - 1];
  // 52-week high = max of last ~252 trading days
  const high52  = Math.max(...prices.slice(-252));
  const drawdown = (latest / high52 - 1) * 100; // negative
  return { latest, high52, drawdown };
}

async function fetchISM() {
  // Returns null if unavailable — app continues without ISM
  try {
    const res = await proxyFetch('https://fred.stlouisfed.org/data/NAPM.txt');
    const text = await res.text();
    const rows = text.trim().split('\n').filter(r => {
      const t = r.trim();
      return t && !t.startsWith('DATE') && !t.startsWith('vintage') && /^\d{4}/.test(t);
    });
    for (let i = rows.length - 1; i >= 0; i--) {
      const parts = rows[i].trim().split(/[\s,]+/);
      const val = parseFloat(parts[1]);
      if (!isNaN(val) && val > 0) return { value: val, date: parts[0] };
    }
  } catch (_) {}

  try {
    const res = await proxyFetch('https://fred.stlouisfed.org/graph/fredgraph.csv?id=NAPM');
    const text = await res.text();
    const rows = text.trim().split('\n').filter(r => r && !r.startsWith('DATE'));
    for (let i = rows.length - 1; i >= 0; i--) {
      const val = parseFloat(rows[i].split(',')[1]);
      if (!isNaN(val) && val > 0) return { value: val, date: rows[i].split(',')[0] };
    }
  } catch (_) {}

  return null; // FRED utilgængelig — vises som N/A
}

async function fetchYield() {
  // Try Yahoo Finance first
  try {
    const res  = await proxyFetch('https://query1.finance.yahoo.com/v8/finance/chart/%5ETNX?interval=1d&range=60d');
    const json = await res.json();
    const closes = json?.chart?.result?.[0]?.indicators?.quote?.[0]?.close;
    if (!closes || closes.length === 0) throw new Error('Tom Yahoo data');
    const val = closes.filter(v => v != null).pop();
    if (!val) throw new Error('Ingen yield data');
    return parseFloat(val.toFixed(3));
  } catch (_) {}
  // Fallback: US Treasury XML API (ingen auth nødvendig)
  try {
    const now    = new Date();
    const yyyymm = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`;
    const url    = `https://home.treasury.gov/resource-center/data-chart-center/interest-rates/pages/xml?data=daily_treasury_yield_curve&field_tdr_date_value_month=${yyyymm}`;
    const res    = await proxyFetch(url);
    const text   = await res.text();
    const matches = [...text.matchAll(/<d:BC_10YEAR[^>]*>([0-9.]+)<\/d:BC_10YEAR>/g)];
    if (matches.length > 0) {
      const val = parseFloat(matches[matches.length - 1][1]);
      if (!isNaN(val)) return val;
    }
  } catch (_) {}
  return null; // Yield utilgængelig
}

// ── Decision engine ───────────────────────────────────────────────────────
function computeSignal({ fg, sp, ism }) {
  const spPct = sp.drawdown; // negative

  // ISM may be null if FRED is unavailable — exclude from logic in that case
  const jaConditions = [
    spPct <= -12,
    fg    <= 35,
    ism != null && ism <= 48,
  ];
  const nejConditions = [
    spPct > -8,
    fg    > 45,
    ism == null || ism >= 50, // if unknown, don't block NEJ
  ];

  const isJA  = jaConditions.some(Boolean);
  const isNEJ = nejConditions.every(Boolean);

  let signal = 'VENT';
  if (isJA)       signal = 'JA';
  else if (isNEJ) signal = 'NEJ';

  // Niveau
  let niveau = '';
  if (spPct <= -25) {
    niveau = 'NIVEAU: STORT';
  } else if (spPct <= -18 || fg <= 25) {
    niveau = 'NIVEAU: 25%';
  } else if (isJA) {
    niveau = 'NIVEAU: 12,5%';
  }

  // Bullets (max 3)
  const bullets = [];
  const spStr = spPct.toFixed(1);

  if (spPct <= -25) {
    bullets.push({ text: `S&P 500 er ${spStr}% fra 52-ugers high — ekstremt niveau`, type: 'warn' });
  } else if (spPct <= -18) {
    bullets.push({ text: `S&P 500 er ${spStr}% fra 52-ugers high — stort fald`, type: 'warn' });
  } else if (spPct <= -12) {
    bullets.push({ text: `S&P 500 er ${spStr}% fra 52-ugers high — over tærskel (−12%)`, type: 'warn' });
  } else {
    bullets.push({ text: `S&P 500 er ${spStr}% fra 52-ugers high — under tærskel`, type: 'ok' });
  }

  if (fg <= 25) {
    bullets.push({ text: `Fear & Greed: ${fg.toFixed(0)} — Ekstrem frygt`, type: 'warn' });
  } else if (fg <= 35) {
    bullets.push({ text: `Fear & Greed: ${fg.toFixed(0)} — Frygt (≤35, trigger aktiv)`, type: 'warn' });
  } else if (fg <= 45) {
    bullets.push({ text: `Fear & Greed: ${fg.toFixed(0)} — Neutral/lav zone`, type: 'mid' });
  } else {
    bullets.push({ text: `Fear & Greed: ${fg.toFixed(0)} — Neutral/grådighed, ingen trigger`, type: 'ok' });
  }

  if (ism == null) {
    bullets.push({ text: `ISM PMI: N/A — FRED utilgængelig, indikator ekskluderet`, type: 'mid' });
  } else if (ism <= 48) {
    bullets.push({ text: `ISM PMI: ${ism.toFixed(1)} — Kontraktion (≤48, trigger aktiv)`, type: 'warn' });
  } else if (ism < 50) {
    bullets.push({ text: `ISM PMI: ${ism.toFixed(1)} — Svag vækst, under 50`, type: 'mid' });
  } else {
    bullets.push({ text: `ISM PMI: ${ism.toFixed(1)} — Ekspansion, ingen trigger`, type: 'ok' });
  }

  return { signal, niveau, bullets };
}

// ── Render ────────────────────────────────────────────────────────────────
function render({ fg, sp, ism, yld }, fromCache, cacheAge) {
  const { signal, niveau, bullets } = computeSignal({ fg, sp, ism });

  // Signal
  const sigEl = $('signal-text');
  sigEl.textContent = signal;
  sigEl.className   = `signal-${signal.toLowerCase()}`;

  const box = $('signal-box');
  box.className = `signal-${signal.toLowerCase()}`;

  const niv = $('niveau-text');
  if (niveau) {
    niv.textContent = niveau;
    niv.className   = 'active';
  } else {
    niv.textContent = '';
    niv.className   = '';
  }

  // Bullets
  const bul = $('bullets');
  bul.innerHTML = '';
  bullets.forEach(b => {
    const li = document.createElement('li');
    li.textContent = b.text;
    li.className   = b.type === 'warn' ? 'warn' : b.type === 'mid' ? 'caution' : '';
    bul.appendChild(li);
  });

  // Table rows
  const rows = [
    {
      name:    'S&P 500 drawdown (52-ugers high)',
      raw:     sp.drawdown,
      display: `${sp.drawdown.toFixed(1)}%`,
      threshold: -12,
      barPct:  Math.min(100, Math.abs(sp.drawdown) / 30 * 100),
      trigger: sp.drawdown <= -12,
      warn:    sp.drawdown <= -18,
    },
    {
      name:    'CNN Fear & Greed Index',
      raw:     fg,
      display: `${fg.toFixed(0)} / 100`,
      threshold: 35,
      barPct:  Math.min(100, (100 - fg) / 100 * 100),
      trigger: fg <= 35,
      warn:    fg <= 25,
    },
    {
      name:    'ISM Manufacturing PMI',
      raw:     ism,
      display: ism != null ? ism.toFixed(1) : 'N/A',
      threshold: 48,
      barPct:  ism != null ? Math.min(100, (60 - ism) / 15 * 100) : 0,
      trigger: ism != null && ism <= 48,
      warn:    ism != null && ism <= 45,
      na:      ism == null,
    },
    {
      name:    'US 10Y Treasury Yield',
      raw:     yld,
      display: yld != null ? `${yld.toFixed(3)}%` : 'N/A',
      barPct:  yld != null ? Math.min(100, yld / 6 * 100) : 0,
      trigger: false,
      warn:    yld != null && yld > 5,
      info:    true,
      na:      yld == null,
    },
  ];

  const tbody = $('table-body');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const barClass = r.warn ? 'warn' : r.trigger ? 'mid' : '';
    const statusClass = r.na ? 'status-mid' : r.info ? '' : r.warn ? 'status-warn' : r.trigger ? 'status-mid' : 'status-ok';
    const statusText  = r.na ? 'N/A' : r.info ? 'INFO' : r.warn ? 'TRIGGER' : r.trigger ? 'TRIGGER' : 'OK';
    const valClass    = r.na ? 'status-mid' : r.warn ? 'status-warn' : r.trigger ? 'status-mid' : '';

    tbody.innerHTML += `
      <tr>
        <td class="td-name">${r.name}</td>
        <td class="td-value ${valClass}" style="text-align:right">${r.display}</td>
        <td class="td-status ${statusClass}">${statusText}</td>
        <td class="td-bar">
          <div class="bar-track">
            <div class="bar-fill ${barClass}" style="width:${Math.max(2, r.barPct)}%"></div>
          </div>
        </td>
      </tr>`;
  });

  // Timestamp
  const now = new Date();
  $('timestamp').innerHTML = `Opdateret: ${now.toLocaleDateString('da-DK')} ${now.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' })}`;
  $('cache-note').textContent = fromCache ? fmtAge(cacheAge) : 'Live data — cache: 24 timer';

  $('loader').classList.add('hidden');
  $('content').classList.remove('hidden');
}

// ── Main load ─────────────────────────────────────────────────────────────
async function loadData(force = false) {
  $('refresh-btn').disabled = true;
  $('error-msg').style.display = 'none';

  if (!force) {
    const cached = loadCache();
    if (cached) {
      render(cached.data, true, cached.age);
      $('refresh-btn').disabled = false;
      return;
    }
  }

  $('loader').classList.remove('hidden');
  $('content').classList.add('hidden');

  try {
    const [fg, sp, ismData, yld] = await Promise.all([
      fetchFearGreed(),
      fetchSP500(),
      fetchISM(),
      fetchYield(),
    ]);

    const data = { fg, sp, ism: ismData ? ismData.value : null, yld };
    saveCache(data);
    render(data, false, 0);
  } catch (err) {
    $('loader').classList.add('hidden');
    const errEl = $('error-msg');
    errEl.textContent = `Fejl ved datahentning: ${err.message}`;
    errEl.style.display = 'block';

    // Try cache anyway
    const cached = loadCache();
    if (cached) {
      render(cached.data, true, cached.age);
      errEl.textContent += ' (viser gammel cache)';
    }
  } finally {
    $('refresh-btn').disabled = false;
  }
}

$('refresh-btn').addEventListener('click', () => loadData(true));

// Boot
loadData();
</script>
</body>
</html>
